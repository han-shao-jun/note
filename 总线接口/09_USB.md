## 一、USB报文帧

USB 2.0的高速（High-Speed）传输使用了一种复杂且高效的数据传输机制，能够以480 Mbps的速率传输数据。在这种高速模式下，数据通过称为**报文帧（Packet Frame）**的结构进行传输。每个报文帧由多个字段组成，每个字段在传输过程中都具有特定的作用。以下是对USB 2.0高速报文帧字段的分析：

### 字段
#### 1. **同步字段（SYNC）**

- **长度**: 8位
- **描述**: 同步字段用于接收器同步时钟，并确定数据包的开始。对于高速模式，SYNC字段的值通常是 `01111110`。

#### 2. **包标识符（PID, Packet Identifier）**

- **长度**: 8位
- **描述**: PID字段用来标识数据包的类型，它由4位类型编码和4位类型编码的反码组成。PID类型包括：
    - **Token 包**: 用于启动数据传输，如`OUT`、`IN`和`SETUP`。
    - **Data 包**: 包含实际的数据传输，如`DATA0`和`DATA1`。
    - **Handshake 包**: 用于传输确认信息，如`ACK`、`NAK`和`STALL`。
    - **Special 包**: 用于特殊情况，如`PRE`（表示低速设备的前导包）等。

#### 3. **地址字段（ADDR, Address Field）**

- **长度**: 7位
- **描述**: 设备地址字段，标识数据包的目的地设备。地址字段是主机和设备之间建立通信的基础。

#### 4. **端点字段（ENDP, Endpoint Field）**

- **长度**: 4位
- **描述**: 标识目标设备上的具体端点编号（0-15），以确定数据传输的具体端点。端点是主机与设备之间数据传输的接口，每个端点可以具有不同的功能（如控制、数据传输等）。

#### 5. **帧号字段（Frame Number Field, 仅适用于SOF包）**

- **长度**: 11位
- **描述**: 帧号字段用于在SOF（Start Of Frame）包中标识当前帧的编号。SOF包用于同步主机与设备的帧节奏，每隔125微秒发出一个SOF包。

#### 6. **数据字段（DATA, Data Field）**

- **长度**: 可变
- **描述**: 数据字段包含实际传输的数据，在高速传输中，单个数据包的数据字段长度最多可以是512字节（对于大容量传输），但在控制传输的端点0上，数据包的最大长度为64字节。

#### 7. **校验和字段（CRC, Cyclic Redundancy Check）**

- **长度**: 通常为16位（对于数据包）或5位（对于Token包）
- **描述**: CRC字段用于错误检测，确保数据传输的完整性。CRC通过多项式算法生成，并附加到数据包的末尾。

#### 8. **握手包（Handshake Packet）**

- **长度**: 8位（包括PID）
- **描述**: 握手包用来确认接收方是否成功接收数据或是否准备好接收数据。常见的握手包包括：
    - **ACK**: 确认接收到数据且无错误。
    - **NAK**: 接收方暂时无法处理数据包。
    - **STALL**: 接收方无法处理数据包，且当前端点已停止通信。

#### 9. **特殊包（Special Packet）**

- **描述**: 这些包用于特定目的，例如 `SOF`（Start of Frame）用于同步时钟，`PRE` 用于标识低速设备的数据包等。

### 报文帧示例分析

一个USB 2.0高速传输的典型报文帧可能如下：

1. **SYNC**: 同步接收器。
2. **PID**: 表示包的类型（例如，`OUT`包）。
3. **ADDR**: 目标设备地址。
4. **ENDP**: 目标设备端点。
5. **DATA**: 包含实际传输的数据。
6. **CRC**: 用于数据校验。
7. **Handshake**: 确认包（如 `ACK`）。

这种帧结构确保了USB设备之间的可靠通信，并使得高速数据传输成为可能。每个字段的设计都是为了最大限度地提高传输效率，同时确保数据的完整性和设备之间的同步。

### 关键点总结：

- **同步字段（SYNC）** 和 **PID字段**: 这些字段在所有类型的传输中都存在，用于帧同步和识别包类型。
- **地址字段（ADDR）** 和 **端点字段（ENDP）**: 用于识别目标设备和端点，这些字段在大多数传输中是通用的。
- **数据字段（DATA）**: 数据包内容在不同类型的传输中可能不同，控制传输的最大长度通常为64字节，批量传输可以达到512字节，而中断和同步传输在高速模式下可以达到1024字节。
- **校验字段（CRC）**: 用于保证数据完整性，存在于大多数类型的传输中，尽管同步传输中没有错误重传机制。
- **握手包（Handshake Packet）**: 仅在控制、批量和中断传输中使用，用于确认数据的接收。
- **特殊包（Special Packet）**: 如`SOF`，用于同步传输的帧时序控制，`PRE`包用于低速设备的前导包。

USB通信（如控制传输、批量传输、中断传输和同步传输）会使用不同的报文帧结构。虽然基本字段如同步字段（SYNC）、包标识符（PID）、地址字段（ADDR）和校验和字段（CRC）等在所有类型的传输中都是通用的，但具体的报文帧结构和内容可能会根据传输类型有所变化。

##  二、USB 2.0报文传输类型

1. **控制传输（Control Transfer）**：
    - 控制传输用于设备的初始化、配置等，通常在端点0上执行。
    - 包括三个阶段：设置阶段（Setup Stage）、数据阶段（Data Stage）和状态阶段（Status Stage）。
    - 报文帧包括：`SETUP`包、`DATA`包和`ACK`包。
    - 最大数据包长度在高速模式下为64字节。
2. **批量传输（Bulk Transfer）**：
    - 用于大数据量、非时间敏感的传输，如文件传输。
    - 没有固定的传输时间间隔，使用`DATA`包和`ACK`包进行通信。
    - 数据包最大长度为512字节（在高速模式下）。
3. **中断传输（Interrupt Transfer）**：
    - 用于小数据量、时间敏感的传输，如键盘输入、鼠标移动。
    - 具有固定的轮询间隔。
    - 数据包的最大长度为1024字节（在高速模式下）。
4. **同步传输（Isochronous Transfer）**：
    - 用于连续的数据流传输，如音频或视频数据。
    - 没有错误重传机制，因此数据包中没有`ACK`或`NAK`包。
    - 数据包的最大长度为1024字节（在高速模式下）。
    - 使用 `SOF`（Start of Frame）包来同步帧。

## 三、复合设备

### 定义 

复合设备是指一个USB设备包含多个独立的功能或接口，每个接口都可以被主机识别为一个独立的设备。每个接口通常对应一个不同的设备类。例如，您可以将鼠标和键盘集成在同一个USB设备中，这样的设备就是一个复合设备。

### 特点

1. **多个接口**: 复合设备具有多个接口，每个接口可以属于不同的设备类。例如，一个复合设备可以同时具有一个HID接口（用于键盘）和另一个HID接口（用于鼠标）。
2. **独立功能**: 虽然复合设备通过一个USB连接器与主机连接，但其每个接口都可以被主机识别为一个独立的功能设备，并且可以加载不同的驱动程序。例如，在复合设备中，键盘接口会加载键盘驱动，鼠标接口会加载鼠标驱动。
3. **单一设备描述符**: 复合设备只有一个设备描述符，该描述符中通常会将 `bDeviceClass` 设置为 `0x00`，表示设备类在接口级别定义。每个接口都有自己的接口描述符来定义其功能。
4. **多个配置描述符（可选）**:复合设备可以有多个配置描述符，但在大多数情况下，它只需要一个配置描述符。配置描述符描述了设备在不同配置下的所有接口和端点。

### 例子

- **鼠标和键盘复合设备**: 一个USB设备包含两个HID接口，一个用于鼠标，一个用于键盘。当插入此设备时，操作系统会识别出一个设备，但会加载两个独立的驱动程序，一个用于键盘，一个用于鼠标。
- **USB打印机和读卡器复合设备**: 一个USB打印机可以集成一个读卡器模块。插入此设备时，主机会识别到一个打印机设备和一个大容量存储设备。
- **多功能打印机（MFP）**: 包含打印、扫描、复印等多种功能的设备。每个功能通过不同的接口呈现，可能包含图像类、存储类等接口。

### 实现

在设计复合设备时，设备描述符通常将 `bDeviceClass` 设置为0（表示类在接口级别定义），然后在接口描述符中指定每个接口的具体类代码。主机在检测到复合设备时，会根据每个接口的类代码加载相应的驱动程序。

### 优势

- **节省端口**: 通过在一个物理设备中集成多个功能，复合设备可以减少对USB端口的需求。
- **更好的集成性**: 复合设备可以将多个相关功能集成在一起，提供更简洁的用户体验。
- **提高灵活性**: 开发者可以在一个设备中实现多种功能，从而满足不同的需求