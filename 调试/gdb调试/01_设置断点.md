GDB（GNU 调试器）通过在被调试程序中添加断点来控制程序执行的流程，便于程序员检查和调试代码。GDB 添加断点的底层原理涉及几个步骤，下面将其分为几个主要部分进行介绍。

### 1. 断点的设置

断点通常是通过指定程序的某个特定位置（例如某行代码、某个函数）设置的。当程序运行时，GDB 会在这些位置暂停执行，让程序员检查程序状态（如变量值、寄存器值等）。

### 2. 底层机制：修改指令

GDB 在底层实现断点的原理是通过修改被调试程序的内存内容来实现的。其具体步骤包括：

1. **查找断点位置**：GDB 首先通过符号表找到用户指定的位置，这个位置可能是代码中的某个行号或某个函数的入口地址。
2. **替换原指令**：GDB 会将断点位置处的原始指令替换为一个特殊的机器指令，这个指令通常是一个“陷阱指令”（Trap Instruction），例如在 x86 架构中，GDB 会将目标地址的指令替换为 `int 3`，这是一个软中断指令，触发时会引起异常，使控制权转移到操作系统。
3. **保存原始指令**：在替换之前，GDB 会保存被替换的原始指令，以便在断点命中时能够正确恢复和继续执行。

### 3. 程序执行过程中的断点命中

当被调试的程序运行到断点位置时，CPU 执行到该“陷阱指令”会触发一个异常，操作系统捕获到这个异常后，会将控制权交给调试器（即 GDB）。GDB 在接收到异常后，执行以下操作：

1. **暂停程序**：GDB 会使程序暂停，以便程序员可以检查程序的状态。
2. **恢复原始指令**：为了让程序可以继续执行，GDB 会将之前替换的原始指令恢复，然后将程序的指令指针（Program Counter, PC）重设到断点位置。
3. **单步执行**：为了绕过断点，GDB 会安排程序执行恢复的原始指令，并暂时禁用断点。执行完原始指令后，GDB 再次设置断点并恢复正常调试状态。

### 4. 操作系统与硬件支持

断点的实现依赖于操作系统和硬件的支持。调试器通过系统调用（如 `ptrace`）来控制被调试程序的执行，修改其内存，设置断点，读取寄存器等。CPU 硬件提供了陷阱机制，当遇到特定指令时触发中断，将控制权交给调试器。此外，操作系统为调试器提供了 API，使其能够对被调试的进程进行监控和控制。